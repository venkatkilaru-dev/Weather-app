@page "/weather"
@inject IHttpClientFactory ClientFactory
@rendermode InteractiveServer
@using WeatherHistoryDataRecorder.Services

<h3>Weather History</h3>

@if (isLoading)
{
    <p>Loading weather data...</p>
}
else if (errorMessage != null)
{
    <p style="color:red">@errorMessage</p>
}
else
{
    <div>
        <button @onclick="SortByDate">Sort by Date</button>
        <button @onclick="SortByTemp">Sort by Max Temp</button>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Min Temp</th>
                <th>Max Temp</th>
                <th>Precipitation</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var w in weather)
            {
                <tr @onclick="() => Select(w)" style="cursor:pointer">
                    <td>@w.Date</td>
                    <td>@w.TemperatureMin</td>
                    <td>@w.TemperatureMax</td>
                    <td>@w.PrecipitationSum</td>
                </tr>
            }
        </tbody>
    </table>

    @if (selected != null)
    {
        <div style="margin-top:20px; padding:10px; border:1px solid #ccc">
            <h4>Details for @selected.Date</h4>
            <p>Min Temp: @selected.TemperatureMin</p>
            <p>Max Temp: @selected.TemperatureMax</p>
            <p>Precipitation: @selected.PrecipitationSum</p>
            @if (selected.Error != null)
            {
                <p style="color:red">Error: @selected.Error</p>
            }
        </div>
    }
}

@code {
    List<WeatherDataResponse> weather = new();
    WeatherDataResponse? selected;
    bool isLoading = true;
    string? errorMessage;

   protected override async Task OnInitializedAsync()
{
    try
    {
        var http = ClientFactory.CreateClient("backend");
        weather = await http.GetFromJsonAsync<List<WeatherDataResponse>>("/api/weather");
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to load weather data: {ex.Message}";
    }

    isLoading = false;
    StateHasChanged(); 
}

    void SortByDate()
{
    weather = weather.OrderBy(w => w.Date).ToList();
    StateHasChanged();
}

void SortByTemp()
{
    weather = weather.OrderByDescending(w => w.TemperatureMax ?? double.MinValue).ToList();
    StateHasChanged();
}
    void Select(WeatherDataResponse w)
    {
        selected = w;
    }
}
