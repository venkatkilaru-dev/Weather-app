@page "/date-parser"
@using WeatherHistoryDataRecorder.Services
@attribute [StreamRendering]

<PageTitle>Date Parser</PageTitle>

<h1>Date Parser</h1>

<p>This component reads and parses dates from the dates.txt file.</p>

@if (parseResults == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Original Input</th>
                <th>ISO Date (yyyy-MM-dd)</th>
                <th>Status</th>
                <th>Error Message</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var result in parseResults)
            {
                <tr class="@(result.IsValid ? "table-success" : "table-danger")">
                    <td>@result.OriginalInput</td>
                    <td>@(result.IsValid ? result.IsoDate : "-")</td>
                    <td>@(result.IsValid ? "✓ Valid" : "✗ Invalid")</td>
                    <td>@(result.ErrorMessage ?? "-")</td>
                </tr>
            }
        </tbody>
    </table>

    <div class="mt-3">
        <h5>Summary</h5>
        <p>Valid Dates: <strong>@parseResults.Count(r => r.IsValid)</strong></p>
        <p>Invalid Dates: <strong>@parseResults.Count(r => !r.IsValid)</strong></p>
    </div>
}

@code {
    private List<DateParseResult>? parseResults;

    protected override async Task OnInitializedAsync()
    {
        // Simulate asynchronous loading
        await Task.Delay(300);

        try
        {
            // Get the base directory of the application
            var basePath = AppContext.BaseDirectory;
            var datesFilePath = Path.Combine(basePath, "..", "..", "..", "Data", "dates.txt");
            var fullPath = Path.GetFullPath(datesFilePath);

            var service = new DateParsingService(fullPath);
            parseResults = service.ReadAndParseAllDates();
        }
        catch (Exception ex)
        {
            parseResults = new List<DateParseResult>
            {
                new DateParseResult
                {
                    OriginalInput = "Error",
                    IsValid = false,
                    ErrorMessage = $"Failed to initialize: {ex.Message}"
                }
            };
        }
    }
}
